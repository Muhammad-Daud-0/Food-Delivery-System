<!-- @format -->

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Restaurant Dashboard - QuickBite</title>
		<link rel="stylesheet" href="/css/styles.css" />
		<style>
			.hero-section {
				background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
				color: white;
				padding: 40px 20px;
			}

			.stats-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
				gap: 20px;
				margin: 30px 0;
			}

			.stat-card {
				background: white;
				padding: 30px;
				border-radius: 15px;
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
				text-align: center;
			}

			.stat-value {
				font-size: 3em;
				font-weight: bold;
				color: #ff6b35;
			}

			.stat-label {
				color: #666;
				margin-top: 10px;
				font-size: 1.1em;
			}

			.order-card {
				background: white;
				padding: 25px;
				border-radius: 12px;
				margin-bottom: 20px;
				box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
			}

			.status-buttons {
				display: flex;
				gap: 10px;
				flex-wrap: wrap;
				margin-top: 15px;
			}

			.status-btn {
				padding: 8px 20px;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				font-size: 0.9em;
				font-weight: 500;
				transition: all 0.3s;
			}

			.status-btn-confirm {
				background: #17a2b8;
				color: white;
			}

			.status-btn-preparing {
				background: #ffc107;
				color: #333;
			}

			.status-btn-ready {
				background: #28a745;
				color: white;
			}

			.tab-buttons {
				display: flex;
				gap: 10px;
				margin-bottom: 30px;
				flex-wrap: wrap;
			}

			.tab-btn {
				padding: 12px 30px;
				border: 2px solid #ff6b35;
				background: white;
				color: #ff6b35;
				border-radius: 8px;
				cursor: pointer;
				font-weight: 500;
				transition: all 0.3s;
			}

			.tab-btn.active {
				background: #ff6b35;
				color: white;
			}

			.tab-content {
				display: none;
			}

			.tab-content.active {
				display: block;
			}

			.modal {
				display: none;
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5);
			}

			.modal.show {
				display: flex;
				justify-content: center;
				align-items: center;
			}

			.modal-content {
				background-color: white;
				padding: 40px;
				border-radius: 15px;
				max-width: 600px;
				width: 90%;
				max-height: 90vh;
				overflow-y: auto;
			}
		</style>
	</head>
	<body>
		<!-- Navigation -->
		<nav class="navbar">
			<a href="/restaurant-dashboard.html" class="navbar-brand">üçï QuickBite</a>
			<ul class="navbar-menu">
				<li><a href="#" id="welcomeText">Welcome!</a></li>
				<li><a href="#" onclick="logout()">Logout</a></li>
			</ul>
		</nav>

		<div style="min-height: 100vh; background: #f5f5f5">
			<!-- Hero Section -->
			<div class="hero-section">
				<div class="container">
					<h1 style="font-size: 2.5em; margin-bottom: 10px">
						üè™ Restaurant Dashboard
					</h1>
					<p style="font-size: 1.2em; opacity: 0.9">
						Manage your restaurant, orders, and menu
					</p>
				</div>
			</div>

			<div class="container" style="margin-top: 40px">
				<div id="alert" class="alert hidden"></div>

				<!-- Stats -->
				<div class="stats-grid" id="statsSection">
					<div class="stat-card">
						<div class="stat-value" id="totalOrders">-</div>
						<div class="stat-label">Total Orders</div>
					</div>
					<div class="stat-card">
						<div class="stat-value" id="pendingOrders">-</div>
						<div class="stat-label">Pending Orders</div>
					</div>
					<div class="stat-card">
						<div class="stat-value" id="menuItems">-</div>
						<div class="stat-label">Menu Items</div>
					</div>
				</div>

				<!-- Tabs -->
				<div class="tab-buttons">
					<button class="tab-btn active" onclick="switchTab('orders')">
						üì¶ Orders
					</button>
					<button class="tab-btn" onclick="switchTab('menu')">üçΩÔ∏è Menu</button>
					<button class="tab-btn" onclick="switchTab('metrics')">
						üìä Live Metrics
					</button>
				</div>

				<!-- Orders Tab -->
				<div id="ordersTab" class="tab-content active">
					<div class="flex-between" style="margin-bottom: 20px">
						<h2>Recent Orders</h2>
						<select
							id="orderStatusFilter"
							onchange="loadOrders()"
							class="form-control"
							style="width: auto">
							<option value="">All Orders</option>
							<option value="pending">Pending</option>
							<option value="confirmed">Confirmed</option>
							<option value="preparing">Preparing</option>
							<option value="ready">Ready</option>
							<option value="delivered">Delivered</option>
						</select>
					</div>
					<div id="ordersList">
						<div class="loading">
							<div class="spinner"></div>
							<p>Loading orders...</p>
						</div>
					</div>
				</div>

				<!-- Menu Tab -->
				<div id="menuTab" class="tab-content">
					<div class="flex-between" style="margin-bottom: 20px">
						<h2>Menu Items</h2>
						<button onclick="openAddMenuModal()" class="btn btn-primary">
							+ Add Item
						</button>
					</div>
					<div id="menuList" class="grid grid-2">
						<div class="loading">
							<div class="spinner"></div>
							<p>Loading menu...</p>
						</div>
					</div>
				</div>

				<!-- Metrics Tab -->
				<div id="metricsTab" class="tab-content">
					<h2 style="margin-bottom: 20px">Live Metrics Dashboard</h2>
					<iframe
						id="metricsFrame"
						src=""
						style="
							width: 100%;
							height: 800px;
							border: none;
							border-radius: 15px;
							box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
						"></iframe>
				</div>
			</div>
		</div>

		<!-- Add Menu Item Modal -->
		<div id="addMenuModal" class="modal">
			<div class="modal-content">
				<h2 style="margin-bottom: 30px">Add Menu Item</h2>
				<form id="addMenuForm">
					<div class="form-group">
						<label for="itemName">Item Name</label>
						<input type="text" id="itemName" class="form-control" required />
					</div>
					<div class="form-group">
						<label for="itemDescription">Description</label>
						<textarea
							id="itemDescription"
							class="form-control"
							rows="3"></textarea>
					</div>
					<div class="form-group">
						<label for="itemCategory">Category</label>
						<select id="itemCategory" class="form-control" required>
							<option value="appetizer">Appetizer</option>
							<option value="main">Main Course</option>
							<option value="dessert">Dessert</option>
							<option value="beverage">Beverage</option>
							<option value="side">Side Dish</option>
						</select>
					</div>
					<div class="form-group">
						<label for="itemPrice">Price ($)</label>
						<input
							type="number"
							id="itemPrice"
							class="form-control"
							step="0.01"
							min="0"
							required />
					</div>
					<div class="form-group">
						<label for="itemPrepTime">Preparation Time (minutes)</label>
						<input
							type="number"
							id="itemPrepTime"
							class="form-control"
							value="15"
							min="1" />
					</div>
					<div class="flex gap-10">
						<button type="submit" class="btn btn-primary">Add Item</button>
						<button
							type="button"
							onclick="closeAddMenuModal()"
							class="btn btn-secondary">
							Cancel
						</button>
					</div>
				</form>
			</div>
		</div>

		<script src="/js/auth.js"></script>
		<script>
			// Check authentication
			if (!requireAuth()) {
				window.location.href = "/login.html";
			}

			const user = getUser();
			if (user.role !== "restaurant") {
				window.location.href = "/customer-dashboard.html";
			}

			document.getElementById(
				"welcomeText"
			).textContent = `Welcome, ${user.name}!`;

			let restaurantId = null;

			// Switch tabs
			function switchTab(tab) {
				document
					.querySelectorAll(".tab-btn")
					.forEach((btn) => btn.classList.remove("active"));
				document
					.querySelectorAll(".tab-content")
					.forEach((content) => content.classList.remove("active"));

				event.target.classList.add("active");
				document.getElementById(tab + "Tab").classList.add("active");

				if (tab === "orders") {
					loadOrders();
				} else if (tab === "menu") {
					loadMenu();
				} else if (tab === "metrics") {
					loadMetrics();
				}
			}

			// Load restaurant info
			async function loadRestaurantInfo() {
				try {
					const data = await apiCall(`/restaurants/tenant/${user.tenantId}`);
					restaurantId = data.data._id;
					loadStats();
				} catch (error) {
					console.error("Error loading restaurant info:", error);
					showAlert("Error loading restaurant information", "error");
				}
			}

			// Load stats
			async function loadStats() {
				try {
					const ordersData = await apiCall("/orders");
					const menuData = await apiCall(`/restaurants/${restaurantId}/menu`);

					const pending = ordersData.data.filter(
						(o) => o.status === "pending" || o.status === "confirmed"
					).length;

					document.getElementById("totalOrders").textContent =
						ordersData.total || 0;
					document.getElementById("pendingOrders").textContent = pending;
					document.getElementById("menuItems").textContent =
						menuData.count || 0;
				} catch (error) {
					console.error("Error loading stats:", error);
				}
			}

			// Load orders
			async function loadOrders() {
				try {
					const statusFilter =
						document.getElementById("orderStatusFilter").value;
					const url = statusFilter
						? `/orders?status=${statusFilter}`
						: "/orders";
					const data = await apiCall(url);

					const container = document.getElementById("ordersList");

					if (data.data.length === 0) {
						container.innerHTML =
							'<p style="text-align: center; color: #666;">No orders found.</p>';
						return;
					}

					container.innerHTML = data.data
						.map(
							(order) => `
          <div class="order-card">
            <div class="flex-between">
              <div>
                <h3>${order.orderNumber}</h3>
                <p style="color: #666; margin: 5px 0;">${formatDate(
									order.createdAt
								)}</p>
              </div>
              <span class="badge ${getStatusBadgeClass(order.status)}">
                ${order.status.replace("_", " ")}
              </span>
            </div>
            <div style="margin-top: 15px;">
              <p><strong>Customer:</strong> ${order.customerId.name}</p>
              <p><strong>Items:</strong> ${order.items.length} items</p>
              <p style="font-size: 1.1em; font-weight: bold; margin-top: 10px;">
                Total: ${formatCurrency(order.total)}
              </p>
            </div>
            ${
							order.status !== "delivered" && order.status !== "cancelled"
								? `
              <div class="status-buttons">
                ${
									order.status === "pending"
										? `
                  <button class="status-btn status-btn-confirm" onclick="updateOrderStatus('${order._id}', 'confirmed')">
                    Confirm Order
                  </button>
                `
										: ""
								}
                ${
									order.status === "confirmed"
										? `
                  <button class="status-btn status-btn-preparing" onclick="updateOrderStatus('${order._id}', 'preparing')">
                    Start Preparing
                  </button>
                `
										: ""
								}
                ${
									order.status === "preparing"
										? `
                  <button class="status-btn status-btn-ready" onclick="updateOrderStatus('${order._id}', 'ready')">
                    Mark as Ready
                  </button>
                `
										: ""
								}
                ${
									order.status === "ready"
										? `
                  <button class="status-btn status-btn-ready" onclick="updateOrderStatus('${order._id}', 'out_for_delivery')">
                    Out for Delivery
                  </button>
                `
										: ""
								}
                ${
									order.status === "out_for_delivery"
										? `
                  <button class="status-btn status-btn-ready" onclick="updateOrderStatus('${order._id}', 'delivered')">
                    Mark as Delivered
                  </button>
                `
										: ""
								}
              </div>
            `
								: ""
						}
          </div>
        `
						)
						.join("");

					loadStats();
				} catch (error) {
					console.error("Error loading orders:", error);
					showAlert("Error loading orders", "error");
				}
			}

			// Update order status
			async function updateOrderStatus(orderId, status) {
				try {
					await apiCall(`/orders/${orderId}/status`, {
						method: "PUT",
						body: JSON.stringify({ status }),
					});

					showAlert(`Order status updated to ${status}`, "success");
					loadOrders();
				} catch (error) {
					console.error("Error updating order:", error);
					showAlert("Error updating order status", "error");
				}
			}

			// Load menu
			async function loadMenu() {
				try {
					const data = await apiCall(`/restaurants/${restaurantId}/menu`);

					const container = document.getElementById("menuList");

					if (data.data.length === 0) {
						container.innerHTML =
							'<p style="text-align: center; color: #666;">No menu items yet. Add your first item!</p>';
						return;
					}

					container.innerHTML = data.data
						.map(
							(item) => `
          <div class="card">
            <div class="flex-between">
              <h3>${item.name}</h3>
              <span class="badge ${
								item.isAvailable ? "badge-success" : "badge-danger"
							}">
                ${item.isAvailable ? "Available" : "Unavailable"}
              </span>
            </div>
            <p style="color: #666; margin: 10px 0;">${
							item.description || ""
						}</p>
            <div style="margin: 15px 0;">
              <span class="badge badge-info">${item.category}</span>
              <span style="font-size: 1.2em; font-weight: bold; color: #667eea; margin-left: 15px;">
                ${formatCurrency(item.price)}
              </span>
            </div>
          </div>
        `
						)
						.join("");

					loadStats();
				} catch (error) {
					console.error("Error loading menu:", error);
					showAlert("Error loading menu", "error");
				}
			}

			// Load metrics
			function loadMetrics() {
				document.getElementById(
					"metricsFrame"
				).src = `/dashboard.html?auto=${user.tenantId}`;
			}

			// Add menu item modal
			function openAddMenuModal() {
				document.getElementById("addMenuModal").classList.add("show");
			}

			function closeAddMenuModal() {
				document.getElementById("addMenuModal").classList.remove("show");
				document.getElementById("addMenuForm").reset();
			}

			// Add menu item
			document
				.getElementById("addMenuForm")
				.addEventListener("submit", async (e) => {
					e.preventDefault();

					try {
						const menuItem = {
							restaurantId: restaurantId,
							name: document.getElementById("itemName").value,
							description: document.getElementById("itemDescription").value,
							category: document.getElementById("itemCategory").value,
							price: parseFloat(document.getElementById("itemPrice").value),
							preparationTime: parseInt(
								document.getElementById("itemPrepTime").value
							),
							isAvailable: true,
						};

						await apiCall("/menu", {
							method: "POST",
							headers: {
								"x-tenant-id": user.tenantId,
							},
							body: JSON.stringify(menuItem),
						});

						showAlert("Menu item added successfully!", "success");
						closeAddMenuModal();
						loadMenu();
					} catch (error) {
						console.error("Error adding menu item:", error);
						showAlert("Error adding menu item", "error");
					}
				});

			// Initial load
			loadRestaurantInfo();
			loadOrders();
		</script>
	</body>
</html>
